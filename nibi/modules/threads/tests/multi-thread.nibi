(use "io" "threads")

(threads::fn nsieve [max] [
  (:= count 0)
  (:= flags (<|> 0 max))
  (loop (:= value 2) (< value max) (set value (+ value 1)) [
    (if (not (at flags value))[
      (set count (+ count 1))
      (loop (:= multiple (* 2 value)) (< multiple max) (set multiple (+ value multiple)) [
        (set (at flags multiple) 1)
      ])
    ])
  ])
  (io::println "primes up to " max " : " count)
])

(:= handle_0 (threads::future (nsieve (bw-lsh 10000 4))))
(:= handle_1 (threads::future (nsieve (bw-lsh 10000 3))))
(:= handle_2 (threads::future (nsieve (bw-lsh 10000 2))))

(while (neq 0 (threads::active)) (nop))
